#!/bin/bash
set -e

if [ $# -lt 1 ]; then
    echo "Usage: speed <file.eng> [--ir]"
    echo "Compiles and runs an eng-lish program."
    exit 1
fi

SOURCE="$1"
shift

# Check file exists
if [ ! -f "$SOURCE" ]; then
    # Try in examples/ directory
    if [ -f "examples/$SOURCE" ]; then
        SOURCE="examples/$SOURCE"
    else
        echo "Error: file '$SOURCE' not found"
        exit 1
    fi
fi

# Use local build if available, otherwise fall back to installed version
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
if [ -f "$SCRIPT_DIR/target/debug/englishc" ]; then
    COMPILER="$SCRIPT_DIR/target/debug/englishc"
elif [ -f "$SCRIPT_DIR/target/release/englishc" ]; then
    COMPILER="$SCRIPT_DIR/target/release/englishc"
else
    COMPILER="englishc"
fi

# If --ir flag, just print IR and exit
if [[ "$*" == *"--ir"* ]]; then
    "$COMPILER" "$SOURCE" --ir
    exit 0
fi

# Get the output binary name (strip path and extension)
BASENAME=$(basename "$SOURCE" .eng)
TMPBIN="/tmp/eng-lish-$BASENAME"

# Compile
"$COMPILER" "$SOURCE"

# Move binary to temp location (englishc outputs to current dir with source stem name)
mv "$BASENAME" "$TMPBIN" 2>/dev/null || true

# Run
"$TMPBIN" "$@"

# Clean up
rm -f "$TMPBIN"
